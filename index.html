<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>üå∏ Nail Sakura Studio</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* –í—Å–µ —Å—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è –ø—Ä–µ–∂–Ω–∏–º–∏ - –∫—Ä–∞—Å–∏–≤—ã–π –¥–∏–∑–∞–π–Ω —Å —Ç–µ–º–∞–º–∏ */
        /* ... [–≤—Å–µ CSS —Å—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è –∫–∞–∫ –≤ –≤–∞—à–µ–º –∫–æ–¥–µ] ... */
    </style>
</head>
<body>
    <!-- –ß–∞—Å—Ç–∏—Ü—ã —Ñ–æ–Ω–∞ -->
    <div id="particles"></div>

    <!-- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ -->
    <div id="themeModal" class="modal-overlay hidden">
        <!-- ... [–æ—Å—Ç–∞—ë—Ç—Å—è –∫–∞–∫ –±—ã–ª–æ] ... -->
    </div>

    <div id="paymentModal" class="modal-overlay hidden">
        <!-- ... [–æ—Å—Ç–∞—ë—Ç—Å—è –∫–∞–∫ –±—ã–ª–æ] ... -->
    </div>

    <div id="reviewModal" class="modal-overlay hidden">
        <!-- ... [–æ—Å—Ç–∞—ë—Ç—Å—è –∫–∞–∫ –±—ã–ª–æ] ... -->
    </div>

    <!-- –ó–ê–ì–†–£–ó–ß–ò–ö -->
    <div id="loader" class="loader-overlay hidden">
        <div class="loader"></div>
    </div>

    <!-- –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø -->
    <div id="notificationContainer"></div>

    <div class="container">
        <!-- –®–ê–ü–ö–ê -->
        <header class="header">
            <div class="logo">
                <span class="logo-icon">üå∏</span>
                <span class="gradient-text">Nail Sakura</span>
            </div>
            <div class="header-actions">
                <button class="btn-icon" onclick="toggleNotifications()" style="position: relative;">
                    <i class="fas fa-bell"></i>
                    <span class="notification-badge" id="notificationBadge"></span>
                </button>
                <button class="theme-toggle" onclick="openThemeModal()"></button>
            </div>
        </header>

        <!-- –≠–ö–†–ê–ù 1: –ì–õ–ê–í–ù–ê–Ø -->
        <div id="mainScreen" class="screen active">
            <!-- ... [–æ—Å—Ç–∞—ë—Ç—Å—è –∫–∞–∫ –±—ã–ª–æ] ... -->
        </div>

        <!-- –≠–ö–†–ê–ù 2: –ó–ê–ü–ò–°–¨ -->
        <div id="bookingScreen" class="screen">
            <!-- ... [–æ—Å—Ç–∞—ë—Ç—Å—è –∫–∞–∫ –±—ã–ª–æ] ... -->
        </div>

        <!-- –≠–ö–†–ê–ù 3: –£–°–õ–£–ì–ò -->
        <div id="servicesScreen" class="screen">
            <!-- ... [–æ—Å—Ç–∞—ë—Ç—Å—è –∫–∞–∫ –±—ã–ª–æ] ... -->
        </div>

        <!-- –≠–ö–†–ê–ù 4: –ß–ê–¢ -->
        <div id="chatScreen" class="screen">
            <!-- ... [–æ—Å—Ç–∞—ë—Ç—Å—è –∫–∞–∫ –±—ã–ª–æ] ... -->
        </div>

        <!-- –≠–ö–†–ê–ù 5: –ú–û–ò –ó–ê–ü–ò–°–ò -->
        <div id="myBookingsScreen" class="screen">
            <!-- ... [–æ—Å—Ç–∞—ë—Ç—Å—è –∫–∞–∫ –±—ã–ª–æ] ... -->
        </div>

        <!-- –≠–ö–†–ê–ù 6: –û–¢–ó–´–í–´ -->
        <div id="reviewsScreen" class="screen">
            <!-- ... [–æ—Å—Ç–∞—ë—Ç—Å—è –∫–∞–∫ –±—ã–ª–æ] ... -->
        </div>

        <!-- –≠–ö–†–ê–ù 7: –ü–ê–ù–ï–õ–¨ –ú–ê–°–¢–ï–†–ê -->
        <div id="masterPanelScreen" class="screen">
            <div class="card">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                    <button class="btn-icon" onclick="showScreen('main')">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <h3 style="flex:1;text-align:center;font-weight:700;">‚öôÔ∏è –ü–∞–Ω–µ–ª—å –º–∞—Å—Ç–µ—Ä–∞</h3>
                    <button class="btn-icon" onclick="refreshMasterPanel()">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>

                <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
                <div style="background:linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));border-radius:var(--border-radius);padding:20px;color:white;margin-bottom:20px;">
                    <h4 style="margin-bottom:15px;font-weight:600;">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–∞–ª–æ–Ω–∞</h4>
                    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:15px;">
                        <div style="text-align:center;">
                            <div style="font-size:24px;font-weight:bold;" id="totalBookingsMaster">0</div>
                            <div style="font-size:12px;opacity:0.9;">–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π</div>
                        </div>
                        <div style="text-align:center;">
                            <div style="font-size:24px;font-weight:bold;" id="todayBookingsMaster">0</div>
                            <div style="font-size:12px;opacity:0.9;">–ù–∞ —Å–µ–≥–æ–¥–Ω—è</div>
                        </div>
                        <div style="text-align:center;">
                            <div style="font-size:24px;font-weight:bold;" id="totalRevenueMaster">0</div>
                            <div style="font-size:12px;opacity:0.9;">–í—ã—Ä—É—á–∫–∞</div>
                        </div>
                    </div>
                </div>

                <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ -->
                <div class="master-actions" style="display:grid;grid-template-columns:repeat(2,1fr);gap:15px;margin-bottom:20px;">
                    <button class="card hover-zoom" onclick="showTodayBookings()" style="text-align:center;padding:15px;cursor:pointer;border:none;background:var(--bg-card);">
                        <div style="font-size:24px;margin-bottom:10px;">üìÖ</div>
                        <div style="font-size:14px;font-weight:600;">–ù–∞ —Å–µ–≥–æ–¥–Ω—è</div>
                    </button>
                    <button class="card hover-zoom" onclick="showAllBookingsMaster()" style="text-align:center;padding:15px;cursor:pointer;border:none;background:var(--bg-card);">
                        <div style="font-size:24px;margin-bottom:10px;">üìã</div>
                        <div style="font-size:14px;font-weight:600;">–í—Å–µ –∑–∞–ø–∏—Å–∏</div>
                    </button>
                    <button class="card hover-zoom" onclick="openBlacklistModal()" style="text-align:center;padding:15px;cursor:pointer;border:none;background:var(--bg-card);">
                        <div style="font-size:24px;margin-bottom:10px;">üö´</div>
                        <div style="font-size:14px;font-weight:600;">–ß–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫</div>
                    </button>
                    <button class="card hover-zoom" onclick="openStatisticsModal()" style="text-align:center;padding:15px;cursor:pointer;border:none;background:var(--bg-card);">
                        <div style="font-size:24px;margin-bottom:10px;">üìä</div>
                        <div style="font-size:14px;font-weight:600;">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
                    </button>
                </div>

                <!-- Google Sheets –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è -->
                <div style="background:rgba(255,182,193,0.1);border-radius:var(--border-radius-sm);padding:20px;margin:20px 0;">
                    <h4 style="margin-bottom:10px;">üìä Google Sheets</h4>
                    <p style="font-size:14px;color:var(--text-muted);margin-bottom:15px;">
                        –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å Google —Ç–∞–±–ª–∏—Ü–µ–π
                    </p>
                    <div style="display:flex;gap:10px;">
                        <button class="btn btn-primary" onclick="syncToGoogleSheets()" style="flex:1;">
                            <i class="fas fa-cloud-upload-alt"></i> –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å
                        </button>
                        <button class="btn btn-secondary" onclick="loadFromGoogleSheets()" style="flex:1;">
                            <i class="fas fa-download"></i> –ó–∞–≥—Ä—É–∑–∏—Ç—å
                        </button>
                    </div>
                    <div style="font-size:12px;color:var(--text-muted);margin-top:10px;">
                        URL: <span id="sheetsUrlStatus">–ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω</span>
                    </div>
                </div>

                <!-- –í—Å–µ –∑–∞–ø–∏—Å–∏ -->
                <div id="masterBookingsList" style="max-height:300px;overflow-y:auto;margin-top:20px;">
                    <!-- –ó–∞–ø–∏—Å–∏ –±—É–¥—É—Ç –∑–¥–µ—Å—å -->
                </div>
            </div>
        </div>
    </div>

    <!-- –ù–∏–∂–Ω—è—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è -->
    <nav class="bottom-nav">
        <button class="nav-item active" onclick="showScreen('main')">
            <div class="nav-icon">üè†</div>
            <div class="nav-label">–ì–ª–∞–≤–Ω–∞—è</div>
        </button>
        <button class="nav-item" onclick="showScreen('booking')">
            <div class="nav-icon">üíÖ</div>
            <div class="nav-label">–ó–∞–ø–∏—Å—å</div>
        </button>
        <button class="nav-item" onclick="showScreen('services')">
            <div class="nav-icon">‚ú®</div>
            <div class="nav-label">–£—Å–ª—É–≥–∏</div>
        </button>
        <button class="nav-item" onclick="showScreen('myBookings')">
            <div class="nav-icon">üìÖ</div>
            <div class="nav-label">–ó–∞–ø–∏—Å–∏</div>
        </button>
        <button class="nav-item" onclick="showMasterPanel()">
            <div class="nav-icon">‚öôÔ∏è</div>
            <div class="nav-label">–ú–∞—Å—Ç–µ—Ä</div>
        </button>
    </nav>

<script>
// ================= –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø =================
const CONFIG = {
    // ‚ö†Ô∏è –ó–ê–ú–ï–ù–ò–¢–ï –≠–¢–£ –°–°–´–õ–ö–£ –ù–ê –í–ê–®–£!
    GOOGLE_SHEETS_URL: "https://script.google.com/macros/s/AKfycbwHLNUtu07o--MVTdjwzOoxi0dkXwyQ72vOPbukrSXMtqni7_uBlSnmryQQB5CD3gUW/exec",
    MASTER_PASSWORD: "admin123",
    PREPAYMENT_AMOUNT: 200,
    APP_NAME: "Nail Sakura Studio",
    VERSION: "3.0.0"
};

// ================= –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï =================
let currentUser = null;
let currentScreen = 'main';
let currentTheme = 'light';
let allBookings = [];
let allReviews = [];
let notifications = [];
let chatMessages = [];
let blacklist = [];
let statistics = {
    revenue: 0,
    visits: 0,
    avgRating: 0,
    totalReviews: 0,
    monthlyRevenue: {},
    popularServices: {}
};

// ================= –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø =================
document.addEventListener('DOMContentLoaded', async function() {
    console.log(`üå∏ ${CONFIG.APP_NAME} v${CONFIG.VERSION}`);
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—É—é —Ç–µ–º—É
    const savedTheme = localStorage.getItem('nailSakuraTheme') || 'light';
    setTheme(savedTheme);
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
    loadLocalData();
    createParticles();
    calculateStatistics();
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
    if (window.Telegram && Telegram.WebApp) {
        initTelegram();
    } else {
        initGuestMode();
    }
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI
    updateUI();
    setupEventListeners();
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º Google Sheets
    updateSheetsStatus();
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º welcome —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    setTimeout(() => {
        showNotification('–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Nail Sakura Studio! üå∏', 'info');
        updateNotificationBadge();
    }, 1000);
});

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram
function initTelegram() {
    const tg = Telegram.WebApp;
    tg.expand();
    tg.setHeaderColor('#FFB6C1');
    tg.setBackgroundColor('#FFE4E9');
    tg.ready();
    
    const user = tg.initDataUnsafe?.user;
    if (user) {
        currentUser = {
            id: user.id,
            firstName: user.first_name,
            lastName: user.last_name || '',
            username: user.username,
            photoUrl: user.photo_url,
            isPremium: user.is_premium || false,
            languageCode: user.language_code || 'ru'
        };
        
        document.getElementById('userName').textContent = `–ü—Ä–∏–≤–µ—Ç, ${currentUser.firstName}!`;
        
        if (currentUser.photoUrl) {
            document.getElementById('userAvatar').innerHTML = `<img src="${currentUser.photoUrl}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">`;
        }
    }
}

// –ì–æ—Å—Ç–µ–≤–æ–π —Ä–µ–∂–∏–º
function initGuestMode() {
    currentUser = {
        id: 'guest_' + Math.random().toString(36).substr(2, 9),
        firstName: '–ì–æ—Å—Ç—å',
        lastName: '',
        username: '',
        photoUrl: '',
        isPremium: false
    };
    
    showNotification('–ó–∞–ø—É—â–µ–Ω–æ –≤ —Ä–µ–∂–∏–º–µ –±—Ä–∞—É–∑–µ—Ä–∞', 'warning');
}

// ================= GOOGLE SHEETS –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø =================
async function saveToGoogleSheets(booking) {
    try {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ URL –Ω–∞—Å—Ç—Ä–æ–µ–Ω
        if (!CONFIG.GOOGLE_SHEETS_URL || CONFIG.GOOGLE_SHEETS_URL.includes('AKfycbwPVf9z8zJX7L4G5p5q5q5q5q5q5q5q5q5q5q5q5q5q5q5q5q5q5q5q')) {
            return false;
        }
        
        updateDebug("üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ Google Sheets...");
        
        const response = await fetch(CONFIG.GOOGLE_SHEETS_URL, {
            method: 'POST',
            mode: 'no-cors', // –í–∞–∂–Ω–æ –¥–ª—è Google Apps Script
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                action: 'addBooking',
                timestamp: new Date().toISOString(),
                userId: booking.userId,
                userName: booking.userName,
                service: booking.service,
                price: booking.price,
                date: booking.date,
                time: booking.time,
                phone: booking.phone,
                status: booking.status,
                prepayment: booking.prepayment,
                prepaymentPaid: booking.prepaymentPaid,
                master: booking.master,
                notes: booking.notes
            })
        });
        
        updateDebug("‚úÖ –î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ Google Sheets");
        return true;
    } catch (error) {
        updateDebug(`‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Google Sheets: ${error.message}`);
        return false;
    }
}

async function loadFromGoogleSheets() {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ URL –Ω–∞—Å—Ç—Ä–æ–µ–Ω
    if (!CONFIG.GOOGLE_SHEETS_URL || CONFIG.GOOGLE_SHEETS_URL.includes('AKfycbwPVf9z8zJX7L4G5p5q5q5q5q5q5q5q5q5q5q5q5q5q5q5q5q5q5q5q')) {
        showNotification('Google Sheets –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω', 'warning');
        return allBookings;
    }
    
    try {
        updateDebug("üì• –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Google Sheets...");
        
        const url = `${CONFIG.GOOGLE_SHEETS_URL}?action=getBookings&t=${Date.now()}`;
        const response = await fetch(url);
        const data = await response.json();
        
        if (data.success && data.bookings) {
            // –û–±—ä–µ–¥–∏–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –∏ –æ–±–ª–∞—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            const combined = [...allBookings, ...data.bookings];
            // –£–±–∏—Ä–∞–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã –ø–æ ID
            const unique = combined.filter((b, index, self) =>
                index === self.findIndex(t => t.id === b.id)
            );
            allBookings = unique;
            saveLocalData();
            updateDebug(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${data.bookings.length} –∑–∞–ø–∏—Å–µ–π –∏–∑ Google Sheets`);
            showNotification(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${data.bookings.length} –∑–∞–ø–∏—Å–µ–π –∏–∑ Google Sheets`, 'success');
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            calculateStatistics();
            if (currentScreen === 'masterPanel') {
                refreshMasterPanel();
            }
        }
    } catch (error) {
        updateDebug(`‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ Google Sheets: ${error.message}`);
        showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ Google Sheets', 'error');
    }
    
    return allBookings;
}

async function syncToGoogleSheets() {
    if (!CONFIG.GOOGLE_SHEETS_URL || CONFIG.GOOGLE_SHEETS_URL.includes('AKfycbwPVf9z8zJX7L4G5p5q5q5q5q5q5q5q5q5q5q5q5q5q5q5q5q5q5q5q')) {
        showNotification('–ù–∞—Å—Ç—Ä–æ–π—Ç–µ Google Sheets URL –≤ –∫–æ–¥–µ', 'warning');
        return;
    }
    
    showLoader();
    let successCount = 0;
    let errorCount = 0;
    
    try {
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤—Å–µ –∑–∞–ø–∏—Å–∏
        for (const booking of allBookings) {
            const success = await saveToGoogleSheets(booking);
            if (success) successCount++;
            else errorCount++;
            
            // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞—Ç—å
            await new Promise(resolve => setTimeout(resolve, 100));
        }
        
        hideLoader();
        
        if (successCount === 0 && errorCount === 0) {
            showNotification('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏', 'info');
        } else {
            showNotification(
                `–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –£—Å–ø–µ—à–Ω–æ: ${successCount}, –û—à–∏–±–æ–∫: ${errorCount}`,
                errorCount === 0 ? 'success' : 'warning'
            );
        }
        
    } catch (error) {
        hideLoader();
        showNotification('–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏: ' + error.message, 'error');
    }
}

function updateSheetsStatus() {
    const statusElement = document.getElementById('sheetsUrlStatus');
    if (statusElement) {
        if (!CONFIG.GOOGLE_SHEETS_URL || CONFIG.GOOGLE_SHEETS_URL.includes('AKfycbwPVf9z8zJX7L4G5p5q5q5q5q5q5q5q5q5q5q5q5q5q5q5q5q5q5q5q')) {
            statusElement.textContent = '–ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω';
            statusElement.style.color = 'var(--accent-warning)';
        } else {
            statusElement.textContent = '–ù–∞—Å—Ç—Ä–æ–µ–Ω';
            statusElement.style.color = 'var(--accent-success)';
        }
    }
}

// ================= –ù–ê–í–ò–ì–ê–¶–ò–Ø –ò –≠–ö–†–ê–ù–´ =================
function showScreen(screenName) {
    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—É—â–∏–π —ç–∫—Ä–∞–Ω
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById(screenName + 'Screen').classList.add('active');
    currentScreen = screenName;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∏–∂–Ω—é—é –Ω–∞–≤–∏–≥–∞—Ü–∏—é
    document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
    const screens = ['main', 'booking', 'services', 'myBookings', 'masterPanel'];
    const index = screens.indexOf(screenName);
    if (index !== -1) {
        document.querySelectorAll('.nav-item')[index].classList.add('active');
    }
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —ç–∫—Ä–∞–Ω–∞
    switch(screenName) {
        case 'myBookings':
            loadUserBookings();
            break;
        case 'chat':
            loadChat();
            break;
        case 'reviews':
            loadAllReviews();
            break;
        case 'masterPanel':
            refreshMasterPanel();
            break;
    }
}

function showMasterPanel() {
    const password = prompt('–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –º–∞—Å—Ç–µ—Ä–∞:');
    if (password === CONFIG.MASTER_PASSWORD) {
        showScreen('masterPanel');
    } else {
        showNotification('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å', 'error');
    }
}

// ================= –ó–ê–ü–ò–°–¨ –ù–ê –£–°–õ–£–ì–£ =================
async function submitBooking() {
    const serviceSelect = document.getElementById('serviceSelect').value;
    const date = document.getElementById('bookingDate').value;
    const time = document.getElementById('bookingTime').value;
    const phone = document.getElementById('clientPhone').value;
    const master = document.getElementById('bookingMaster').value;
    const notes = document.getElementById('bookingNotes').value;
    const prepayment = document.getElementById('prepaymentCheckbox').checked;
    
    if (!date) {
        showNotification('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É!', 'warning');
        return;
    }
    
    if (!phone) {
        showNotification('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω!', 'warning');
        return;
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞
    if (isInBlacklist(phone)) {
        showNotification('–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –∑–∞–ø–∏—Å—å –Ω–µ–≤–æ–∑–º–æ–∂–Ω–∞', 'error');
        return;
    }
    
    // –ü–∞—Ä—Å–∏–º —É—Å–ª—É–≥—É
    const [serviceName, servicePrice] = serviceSelect.split('|');
    
    const booking = {
        id: Date.now(),
        userId: currentUser.id,
        userName: `${currentUser.firstName} ${currentUser.lastName || ''}`.trim(),
        userInfo: currentUser.username ? `@${currentUser.username}` : `ID: ${currentUser.id}`,
        service: serviceName,
        price: parseInt(servicePrice),
        duration: getServiceDuration(serviceName),
        date: date,
        time: time,
        phone: phone,
        master: master || '',
        notes: notes || '',
        status: 'pending',
        prepayment: prepayment,
        prepaymentPaid: false,
        createdAt: new Date().toISOString()
    };
    
    // –ï—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø—Ä–µ–¥–æ–ø–ª–∞—Ç–∞, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    if (prepayment) {
        showModal('paymentModal');
        window.currentBooking = booking;
        return;
    }
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∑–∞–ø–∏—Å—å
    saveBooking(booking);
}

async function saveBooking(booking) {
    showLoader();
    
    try {
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
        allBookings.push(booking);
        saveLocalData();
        calculateStatistics();
        
        // –ü—ã—Ç–∞–µ–º—Å—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ Google Sheets
        let sheetsSuccess = false;
        if (CONFIG.GOOGLE_SHEETS_URL && !CONFIG.GOOGLE_SHEETS_URL.includes('AKfycbwPVf9z8zJX7L4G5p5q5q5q5q5q5q5q5q5q5q5q5q5q5q5q5q5q5q5q')) {
            sheetsSuccess = await saveToGoogleSheets(booking);
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        addNotification(
            '–ó–∞–ø–∏—Å—å —Å–æ–∑–¥–∞–Ω–∞', 
            `–í—ã –∑–∞–ø–∏—Å–∞–Ω—ã –Ω–∞ ${formatDate(booking.date)} –≤ ${booking.time}\n–£—Å–ª—É–≥–∞: ${booking.service}`,
            'success'
        );
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
        setTimeout(() => {
            hideLoader();
            showNotification(
                sheetsSuccess 
                    ? `üéâ –ó–∞–ø–∏—Å—å —Å–æ–∑–¥–∞–Ω–∞ –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–∞!\n${booking.service}\n${formatDate(booking.date)} –≤ ${booking.time}`
                    : `üéâ –ó–∞–ø–∏—Å—å —Å–æ–∑–¥–∞–Ω–∞!\n${booking.service}\n${formatDate(booking.date)} –≤ ${booking.time}`,
                'success'
            );
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
            resetBookingForm();
            
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –Ω–∞ –≥–ª–∞–≤–Ω—É—é
            showScreen('main');
        }, 1500);
        
    } catch (error) {
        hideLoader();
        showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–ø–∏—Å–∏: ' + error.message, 'error');
    }
}

// ================= –ü–ê–ù–ï–õ–¨ –ú–ê–°–¢–ï–†–ê =================
function refreshMasterPanel() {
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    const today = new Date().toISOString().split('T')[0];
    const todayBookings = allBookings.filter(b => b.date === today);
    const revenue = allBookings.reduce((sum, b) => {
        if (b.status === 'completed') return sum + b.price;
        return sum;
    }, 0);
    
    document.getElementById('totalBookingsMaster').textContent = allBookings.length;
    document.getElementById('todayBookingsMaster').textContent = todayBookings.length;
    document.getElementById('totalRevenueMaster').textContent = revenue + '‚ÇΩ';
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∑–∞–ø–∏—Å–µ–π
    showAllBookingsMaster();
}

function showAllBookingsMaster() {
    const container = document.getElementById('masterBookingsList');
    if (!container) return;
    
    if (allBookings.length === 0) {
        container.innerHTML = '<p style="text-align:center;padding:40px;color:var(--text-muted);">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</p>';
        return;
    }
    
    // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –¥–∞—Ç–µ (–Ω–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É)
    const sorted = [...allBookings].sort((a, b) => new Date(b.date) - new Date(a.date));
    
    container.innerHTML = sorted.map(booking => `
        <div class="card" style="margin-bottom:10px;padding:15px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                <div>
                    <div style="font-weight:600;margin-bottom:5px;">${booking.service}</div>
                    <div style="font-size:12px;color:var(--text-muted);">
                        üë§ ${booking.userName} ‚Ä¢ üìÖ ${formatDate(booking.date)} üïê ${booking.time}
                    </div>
                </div>
                <span class="status-badge status-${booking.status}" 
                      onclick="changeBookingStatus(${booking.id}, '${booking.status === 'confirmed' ? 'pending' : 'confirmed'}')"
                      style="cursor:pointer;">
                    ${booking.status === 'confirmed' ? '‚úÖ' : 
                      booking.status === 'completed' ? '‚úÖ' : 
                      booking.status === 'cancelled' ? '‚ùå' : '‚è≥'}
                </span>
            </div>
            <div style="font-size:12px;color:var(--text-muted);">
                üìû ${booking.phone} ‚Ä¢ üíµ ${booking.price}‚ÇΩ
                ${booking.prepayment ? ' ‚Ä¢ üí≥ –ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞' : ''}
                ${booking.master ? ` ‚Ä¢ üë©‚Äçüé® ${booking.master}` : ''}
            </div>
            <div style="display:flex;gap:5px;margin-top:10px;">
                <button class="btn btn-success" onclick="changeBookingStatus(${booking.id}, 'completed')" style="padding:5px 10px;font-size:12px;flex:1;">
                    –ó–∞–≤–µ—Ä—à–∏—Ç—å
                </button>
                <button class="btn btn-danger" onclick="changeBookingStatus(${booking.id}, 'cancelled')" style="padding:5px 10px;font-size:12px;flex:1;">
                    –û—Ç–º–µ–Ω–∏—Ç—å
                </button>
            </div>
        </div>
    `).join('');
}

function changeBookingStatus(bookingId, newStatus) {
    const booking = allBookings.find(b => b.id === bookingId);
    if (booking) {
        booking.status = newStatus;
        saveLocalData();
        calculateStatistics();
        refreshMasterPanel();
        showNotification(`–°—Ç–∞—Ç—É—Å –∑–∞–ø–∏—Å–∏ –∏–∑–º–µ–Ω–µ–Ω –Ω–∞: ${newStatus}`, 'success');
        
        // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Å Google Sheets
        if (CONFIG.GOOGLE_SHEETS_URL && !CONFIG.GOOGLE_SHEETS_URL.includes('AKfycbwPVf9z8zJX7L4G5p5q5q5q5q5q5q5q5q5q5q5q5q5q5q5q5q5q5q5q')) {
            saveToGoogleSheets(booking);
        }
    }
}

function showTodayBookings() {
    const today = new Date().toISOString().split('T')[0];
    const todayBookings = allBookings.filter(b => b.date === today);
    
    if (todayBookings.length === 0) {
        showNotification('–ù–∞ —Å–µ–≥–æ–¥–Ω—è –∑–∞–ø–∏—Å–µ–π –Ω–µ—Ç', 'info');
        return;
    }
    
    let message = `üìÖ –ó–∞–ø–∏—Å–∏ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è (${todayBookings.length}):\n\n`;
    todayBookings.forEach((booking, index) => {
        message += `${index + 1}. ${booking.service} - ${booking.time}\n`;
        message += `   üë§ ${booking.userName}\n`;
        message += `   üìû ${booking.phone}\n`;
        message += `   üíµ ${booking.price}‚ÇΩ\n`;
        message += `   –°—Ç–∞—Ç—É—Å: ${booking.status}\n\n`;
    });
    
    alert(message);
}

// ================= –£–¢–ò–õ–ò–¢–´ =================
function updateDebug(message) {
    console.log(message);
    // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ UI –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
}

function loadLocalData() {
    try {
        allBookings = JSON.parse(localStorage.getItem('nailSakuraBookings') || '[]');
        allReviews = JSON.parse(localStorage.getItem('nailSakuraReviews') || '[]');
        notifications = JSON.parse(localStorage.getItem('nailSakuraNotifications') || '[]');
        blacklist = JSON.parse(localStorage.getItem('nailSakuraBlacklist') || '[]');
        chatMessages = JSON.parse(localStorage.getItem('nailSakuraChat') || '[]');
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
    }
}

function saveLocalData() {
    try {
        localStorage.setItem('nailSakuraBookings', JSON.stringify(allBookings));
        localStorage.setItem('nailSakuraReviews', JSON.stringify(allReviews));
        localStorage.setItem('nailSakuraNotifications', JSON.stringify(notifications));
        localStorage.setItem('nailSakuraBlacklist', JSON.stringify(blacklist));
        localStorage.setItem('nailSakuraChat', JSON.stringify(chatMessages));
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö:', error);
    }
}

// –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞, –æ—Ç–∑—ã–≤—ã, —á–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫, —á–∞—Ç) –æ—Å—Ç–∞—é—Ç—Å—è –∫–∞–∫ –±—ã–ª–∏ –≤ –≤–∞—à–µ–º –∫–æ–¥–µ
// ... [–≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π] ...

// ================= –ó–ê–ü–£–°–ö –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø =================
window.onload = function() {
    console.log('üå∏ Nail Sakura Studio initialized');
};
</script>
</body>
</html>
