<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üå∏ Nail Sakura Studio</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial; background: #FFE4E9; padding: 20px; padding-bottom: 80px; }
        .screen { display: none; }
        .screen.active { display: block; animation: fadeIn 0.3s; }
        .btn { display: block; width: 100%; padding: 16px; margin: 10px 0; background: #FFB6C1; color: white; border: none; border-radius: 10px; cursor: pointer; font-size: 16px; }
        .btn-secondary { background: white; color: #FFB6C1; border: 2px solid #FFB6C1; }
        input, select { width: 100%; padding: 12px; margin: 8px 0; border: 2px solid #FFB6C1; border-radius: 8px; font-size: 16px; }
        .booking-card { background: white; padding: 15px; margin: 10px 0; border-radius: 10px; border-left: 4px solid #FFB6C1; }
        .status-badge { padding: 3px 8px; border-radius: 5px; font-size: 12px; margin-left: 10px; }
        .status-pending { background: #FFF3CD; color: #856404; }
        .status-confirmed { background: #D4EDDA; color: #155724; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: white; display: flex; padding: 10px; border-top: 2px solid #FFB6C1; }
        .nav-btn { flex: 1; padding: 10px; border: none; background: none; font-size: 20px; color: #888; }
        .nav-btn.active { color: #FFB6C1; }
        .debug { background: rgba(0,0,0,0.8); color: #0f0; padding: 5px; font-family: monospace; font-size: 12px; margin: 5px; border-radius: 3px; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>
    <!-- –û—Ç–ª–∞–¥–∫–∞ -->
    <div class="debug" id="debug">–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...</div>

    <!-- –ì–õ–ê–í–ù–ê–Ø -->
    <div id="mainScreen" class="screen active">
        <div style="text-align:center; margin:20px 0;">
            <div id="userAvatar" style="width:80px;height:80px;background:#FFB6C1;border-radius:50%;margin:0 auto;font-size:32px;line-height:80px;">üë§</div>
            <h2 id="userName">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h2>
            <p id="userInfo" style="color:#8B475D;">Nail Sakura Studio</p>
        </div>
        
        <button class="btn" onclick="showScreen('booking')">üíÖ –ó–∞–ø–∏—Å–∞—Ç—å—Å—è</button>
        <button class="btn" onclick="showScreen('services')">‚ú® –£—Å–ª—É–≥–∏</button>
        <button class="btn" onclick="showScreen('myBookings')">üìÖ –ú–æ–∏ –∑–∞–ø–∏—Å–∏</button>
        <button class="btn btn-secondary" onclick="showScreen('masterLogin')">‚öôÔ∏è –í—Ö–æ–¥ –¥–ª—è –º–∞—Å—Ç–µ—Ä–∞</button>
    </div>

    <!-- –ó–ê–ü–ò–°–¨ -->
    <div id="bookingScreen" class="screen">
        <button onclick="showScreen('main')" style="background:none;border:none;font-size:24px;cursor:pointer;">‚Üê</button>
        <h2>üìù –ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å</h2>
        
        <select id="serviceSelect">
            <option value="–ú–∞–Ω–∏–∫—é—Ä|1500">üíÖ –ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –º–∞–Ω–∏–∫—é—Ä - 1500‚ÇΩ</option>
            <option value="–ì–µ–ª—å-–ª–∞–∫|2000">‚ú® –ü–æ–∫—Ä—ã—Ç–∏–µ –≥–µ–ª—å-–ª–∞–∫–æ–º - 2000‚ÇΩ</option>
            <option value="–î–∏–∑–∞–π–Ω|1000">üé® –î–∏–∑–∞–π–Ω –Ω–æ–≥—Ç–µ–π - 1000‚ÇΩ</option>
            <option value="SPA-—É—Ö–æ–¥|1800">üíé SPA-—É—Ö–æ–¥ - 1800‚ÇΩ</option>
        </select>
        
        <input type="date" id="bookingDate">
        <select id="bookingTime">
            <option>10:00</option><option>11:00</option><option>12:00</option><option>13:00</option>
            <option>14:00</option><option>15:00</option><option>16:00</option><option>17:00</option><option>18:00</option>
        </select>
        
        <input type="tel" id="clientPhone" placeholder="–í–∞—à —Ç–µ–ª–µ—Ñ–æ–Ω (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
        
        <button class="btn" onclick="submitBooking()">‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–ø–∏—Å—å</button>
    </div>

    <!-- –£–°–õ–£–ì–ò -->
    <div id="servicesScreen" class="screen">
        <button onclick="showScreen('main')" style="background:none;border:none;font-size:24px;cursor:pointer;">‚Üê</button>
        <h2>üíÖ –ù–∞—à–∏ —É—Å–ª—É–≥–∏</h2>
        <div class="booking-card"><h3>üíÖ –ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –º–∞–Ω–∏–∫—é—Ä</h3><p>–û–±—Ä–∞–±–æ—Ç–∫–∞ + –ø–æ–∫—Ä—ã—Ç–∏–µ</p><strong>1500‚ÇΩ ‚Ä¢ 90 –º–∏–Ω</strong></div>
        <div class="booking-card"><h3>‚ú® –ü–æ–∫—Ä—ã—Ç–∏–µ –≥–µ–ª—å-–ª–∞–∫–æ–º</h3><p>–î–æ–ª–≥–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ</p><strong>2000‚ÇΩ ‚Ä¢ 120 –º–∏–Ω</strong></div>
        <div class="booking-card"><h3>üé® –î–∏–∑–∞–π–Ω –Ω–æ–≥—Ç–µ–π</h3><p>–†–∏—Å—É–Ω–∫–∏, —Å—Ç—Ä–∞–∑—ã, –≥—Ä–∞–¥–∏–µ–Ω—Ç</p><strong>1000‚ÇΩ ‚Ä¢ 60 –º–∏–Ω</strong></div>
        <div class="booking-card"><h3>üíé SPA-—É—Ö–æ–¥</h3><p>–£–≤–ª–∞–∂–Ω–µ–Ω–∏–µ –∏ –ø–∏—Ç–∞–Ω–∏–µ</p><strong>1800‚ÇΩ ‚Ä¢ 75 –º–∏–Ω</strong></div>
    </div>

    <!-- –ú–û–ò –ó–ê–ü–ò–°–ò -->
    <div id="myBookingsScreen" class="screen">
        <button onclick="showScreen('main')" style="background:none;border:none;font-size:24px;cursor:pointer;">‚Üê</button>
        <h2>üìÖ –ú–æ–∏ –∑–∞–ø–∏—Å–∏</h2>
        <div id="bookingsList">
            <p style="text-align:center;padding:40px;">–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–ø–∏—Å–µ–π...</p>
        </div>
        <button class="btn" onclick="loadUserBookings()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
    </div>

    <!-- –í–•–û–î –ú–ê–°–¢–ï–†–ê -->
    <div id="masterLoginScreen" class="screen">
        <button onclick="showScreen('main')" style="background:none;border:none;font-size:24px;cursor:pointer;">‚Üê</button>
        <div style="text-align:center; margin:40px 0;">
            <div style="font-size:48px;">üîê</div>
            <h2>–í—Ö–æ–¥ –¥–ª—è –º–∞—Å—Ç–µ—Ä–∞</h2>
            <p>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–∞—Å—Ç–µ—Ä-–ø–∞—Ä–æ–ª—å</p>
        </div>
        <input type="password" id="masterPassword" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
        <button class="btn" onclick="loginMaster()">–í–æ–π—Ç–∏</button>
    </div>

    <!-- –ü–ê–ù–ï–õ–¨ –ú–ê–°–¢–ï–†–ê -->
    <div id="masterPanelScreen" class="screen">
        <button onclick="logoutMaster()" style="background:none;border:none;font-size:24px;cursor:pointer;">‚Üê –í—ã–π—Ç–∏</button>
        <h2>‚öôÔ∏è –ü–∞–Ω–µ–ª—å –º–∞—Å—Ç–µ—Ä–∞</h2>
        
        <div style="background:#FFE4E9;padding:15px;border-radius:10px;margin:10px 0;">
            <h3>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
            <p>–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π: <span id="totalBookings">0</span></p>
            <p>–ù–∞ —Å–µ–≥–æ–¥–Ω—è: <span id="todayBookings">0</span></p>
            <p>–í—ã—Ä—É—á–∫–∞: <span id="totalRevenue">0</span>‚ÇΩ</p>
        </div>
        
        <div id="allBookingsList" style="max-height:400px;overflow-y:auto;margin-bottom:20px;">
            <!-- –í—Å–µ –∑–∞–ø–∏—Å–∏ –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å -->
        </div>
        
        <button class="btn" onclick="refreshMasterPanel()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
        <button class="btn" onclick="exportToGoogleSheets()">üì§ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å Google Sheets</button>
        <button class="btn btn-secondary" onclick="exportToJSON()">üì• –°–∫–∞—á–∞—Ç—å –¥–∞–Ω–Ω—ã–µ (JSON)</button>
    </div>

    <!-- –ù–ò–ñ–ù–Ø–Ø –ù–ê–í–ò–ì–ê–¶–ò–Ø -->
    <nav class="bottom-nav">
        <button class="nav-btn active" onclick="showScreen('main')">üè†</button>
        <button class="nav-btn" onclick="showScreen('booking')">üíÖ</button>
        <button class="nav-btn" onclick="showScreen('services')">‚ú®</button>
        <button class="nav-btn" onclick="showScreen('myBookings')">üìÖ</button>
    </nav>

<script>
// ================= –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø =================
// ‚ö†Ô∏è –í–ê–ñ–ù–û: –ó–ê–ú–ï–ù–ò–¢–ï –≠–¢–£ –°–°–´–õ–ö–£ –ù–ê –í–ê–®–£!
const GOOGLE_SHEETS_URL = "https://script.google.com/macros/s/AKfycbzA7ukePYKIEy0xAK4E41Vw_FHPQky9Ks0jfnlQhUw94Vsk-fTsiu1ZIiFVnaDX3anS/exec";

const MASTER_PASSWORD = "sakura2024";

// ================= –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï =================
let currentUser = null;
let currentScreen = 'main';
let isMasterMode = false;
let allBookings = [];

// ================= –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø =================
function initApp() {
    updateDebug("üå∏ –ó–∞–ø—É—Å–∫ Nail Sakura Studio");
    
    // 1. –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ localStorage
    loadLocalData();
    
    // 2. –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ Telegram
    if (window.Telegram && Telegram.WebApp) {
        const tg = Telegram.WebApp;
        tg.expand();
        tg.setHeaderColor('#FFB6C1');
        tg.setBackgroundColor('#FFE4E9');
        tg.ready();
        
        const user = tg.initDataUnsafe?.user;
        if (user) {
            currentUser = {
                id: user.id,
                firstName: user.first_name,
                lastName: user.last_name || '',
                username: user.username,
                photoUrl: user.photo_url,
                isPremium: user.is_premium || false
            };
            updateDebug(`üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å Telegram: ${currentUser.firstName} (ID: ${currentUser.id})`);
        } else {
            currentUser = { id: 'guest', firstName: '–ì–æ—Å—Ç—å' };
            updateDebug("‚ö†Ô∏è –î–∞–Ω–Ω—ã–µ Telegram –Ω–µ –ø–æ–ª—É—á–µ–Ω—ã. –ó–∞–ø—É—â–µ–Ω–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ?");
        }
    } else {
        currentUser = { id: 'guest', firstName: '–ì–æ—Å—Ç—å' };
        updateDebug("üåê –†–µ–∂–∏–º –±—Ä–∞—É–∑–µ—Ä–∞ (–Ω–µ –≤ Telegram)");
    }
    
    // 3. –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
    updateUI();
    
    // 4. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ–≥–æ–¥–Ω—è—à–Ω—é—é –¥–∞—Ç—É
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('bookingDate').value = today;
    document.getElementById('bookingDate').min = today;
    
    updateDebug("‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ");
}

// ================= LOCALSTORAGE =================
function loadLocalData() {
    try {
        const saved = localStorage.getItem('nailSakuraBookings');
        if (saved) {
            allBookings = JSON.parse(saved);
            updateDebug(`üìÇ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${allBookings.length} –∑–∞–ø–∏—Å–µ–π –∏–∑ localStorage`);
        }
    } catch (e) {
        updateDebug(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${e.message}`);
    }
}

function saveLocalData() {
    try {
        localStorage.setItem('nailSakuraBookings', JSON.stringify(allBookings));
    } catch (e) {
        updateDebug(`‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ${e.message}`);
    }
}

// ================= –û–ë–ù–û–í–õ–ï–ù–ò–ï –ò–ù–¢–ï–†–§–ï–ô–°–ê =================
function updateUI() {
    if (!currentUser) return;
    
    document.getElementById('userName').textContent = `–ü—Ä–∏–≤–µ—Ç, ${currentUser.firstName}!`;
    
    const userInfo = document.getElementById('userInfo');
    if (currentUser.id !== 'guest') {
        userInfo.textContent = `ID: ${currentUser.id}${currentUser.isPremium ? ' ‚≠ê' : ''}`;
    } else {
        userInfo.textContent = '–ó–∞–ø—É—â–µ–Ω–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ';
    }
    
    const avatar = document.getElementById('userAvatar');
    if (currentUser.photoUrl) {
        avatar.innerHTML = `<img src="${currentUser.photoUrl}" style="width:100%;height:100%;border-radius:50%;">`;
    } else if (currentUser.firstName) {
        avatar.textContent = currentUser.firstName[0].toUpperCase();
    }
}

// ================= –ù–ê–í–ò–ì–ê–¶–ò–Ø =================
function showScreen(screenName) {
    // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —ç–∫—Ä–∞–Ω—ã
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—ã–π —ç–∫—Ä–∞–Ω
    document.getElementById(screenName + 'Screen').classList.add('active');
    currentScreen = screenName;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∏–∂–Ω–µ–µ –º–µ–Ω—é
    document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
    if (screenName === 'main') document.querySelector('.nav-btn:nth-child(1)').classList.add('active');
    if (screenName === 'booking') document.querySelector('.nav-btn:nth-child(2)').classList.add('active');
    if (screenName === 'services') document.querySelector('.nav-btn:nth-child(3)').classList.add('active');
    if (screenName === 'myBookings') document.querySelector('.nav-btn:nth-child(4)').classList.add('active');
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
    if (screenName === 'myBookings') setTimeout(loadUserBookings, 100);
    if (screenName === 'masterPanel') setTimeout(refreshMasterPanel, 100);
}

// ================= –°–û–ó–î–ê–ù–ò–ï –ó–ê–ü–ò–°–ò =================
async function submitBooking() {
    const serviceSelect = document.getElementById('serviceSelect').value;
    const date = document.getElementById('bookingDate').value;
    const time = document.getElementById('bookingTime').value;
    const phone = document.getElementById('clientPhone').value;
    
    if (!date) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É!');
        return;
    }
    
    // –ü–∞—Ä—Å–∏–º —É—Å–ª—É–≥—É
    const [serviceName, servicePrice] = serviceSelect.split('|');
    
    const booking = {
        id: Date.now(),
        userId: currentUser.id,
        userName: `${currentUser.firstName} ${currentUser.lastName || ''}`.trim(),
        userInfo: currentUser.username ? `@${currentUser.username}` : `ID: ${currentUser.id}`,
        service: serviceName,
        price: parseInt(servicePrice),
        date: date,
        time: time,
        phone: phone || '–ù–µ —É–∫–∞–∑–∞–Ω',
        status: 'pending',
        createdAt: new Date().toISOString()
    };
    
    updateDebug(`üìù –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏: ${serviceName} –Ω–∞ ${date} ${time}`);
    
    // 1. –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
    allBookings.push(booking);
    saveLocalData();
    
    // 2. –ü—ã—Ç–∞–µ–º—Å—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ Google Sheets
    let sheetsSuccess = false;
    if (GOOGLE_SHEETS_URL && !GOOGLE_SHEETS_URL.includes('AKfycbwPVf9z8zJX7L4G5p5q5q5q5q5q5q5q5q5q5q5q5q5q5q5q5q5q5q5q')) {
        sheetsSuccess = await saveToGoogleSheets(booking);
    }
    
    // 3. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    alert(sheetsSuccess 
        ? `üéâ –ó–∞–ø–∏—Å—å —Å–æ–∑–¥–∞–Ω–∞ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ Google Sheets!\n${serviceName}\n${date} –≤ ${time}`
        : `üéâ –ó–∞–ø–∏—Å—å —Å–æ–∑–¥–∞–Ω–∞ (—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ)!\n${serviceName}\n${date} –≤ ${time}`
    );
    
    // 4. –í–æ–∑–≤—Ä–∞—â–∞–µ–º –Ω–∞ –≥–ª–∞–≤–Ω—É—é
    showScreen('main');
}

// ================= GOOGLE SHEETS –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø =================
async function saveToGoogleSheets(booking) {
    try {
        updateDebug("üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ Google Sheets...");
        
        const response = await fetch(GOOGLE_SHEETS_URL, {
            method: 'POST',
            mode: 'no-cors', // –í–∞–∂–Ω–æ –¥–ª—è Google Apps Script
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                action: 'addBooking',
                timestamp: new Date().toISOString(),
                userId: booking.userId,
                userName: booking.userName,
                service: booking.service,
                price: booking.price,
                date: booking.date,
                time: booking.time,
                phone: booking.phone,
                status: booking.status
            })
        });
        
        updateDebug("‚úÖ –î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ Google Sheets");
        return true;
    } catch (error) {
        updateDebug(`‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Google Sheets: ${error.message}`);
        return false;
    }
}

async function loadFromGoogleSheets() {
    if (!GOOGLE_SHEETS_URL || GOOGLE_SHEETS_URL.includes('AKfycbwPVf9z8zJX7L4G5p5q5q5q5q5q5q5q5q5q5q5q5q5q5q5q5q5q5q5q')) {
        return allBookings;
    }
    
    try {
        updateDebug("üì• –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Google Sheets...");
        
        const url = `${GOOGLE_SHEETS_URL}?action=getBookings`;
        const response = await fetch(url);
        const data = await response.json();
        
        if (data.success && data.bookings) {
            // –û–±—ä–µ–¥–∏–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –∏ –æ–±–ª–∞—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            const combined = [...allBookings, ...data.bookings];
            // –£–±–∏—Ä–∞–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã –ø–æ ID
            const unique = combined.filter((b, index, self) =>
                index === self.findIndex(t => t.id === b.id)
            );
            allBookings = unique;
            saveLocalData();
            updateDebug(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${data.bookings.length} –∑–∞–ø–∏—Å–µ–π –∏–∑ Google Sheets`);
        }
    } catch (error) {
        updateDebug(`‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ Google Sheets: ${error.message}`);
    }
    
    return allBookings;
}

// ================= –ó–ê–ì–†–£–ó–ö–ê –ó–ê–ü–ò–°–ï–ô –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø =================
function loadUserBookings() {
    const userBookings = allBookings.filter(b => b.userId === currentUser.id);
    const container = document.getElementById('bookingsList');
    
    if (userBookings.length === 0) {
        container.innerHTML = '<p style="text-align:center;padding:40px;">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π</p>';
        return;
    }
    
    // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –¥–∞—Ç–µ (–Ω–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É)
    const sorted = userBookings.sort((a, b) => new Date(b.date) - new Date(a.date));
    
    container.innerHTML = sorted.map(b => `
        <div class="booking-card">
            <div style="display:flex;justify-content:space-between;align-items:start;">
                <div>
                    <strong>${b.service}</strong><br>
                    <small>üìÖ ${b.date} üïê ${b.time}</small>
                </div>
                <span class="status-badge status-${b.status === 'confirmed' ? 'confirmed' : 'pending'}">
                    ${b.status === 'confirmed' ? '‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ' : '‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ'}
                </span>
            </div>
            <div style="margin-top:10px;">
                <small>üíµ ${b.price}‚ÇΩ</small><br>
                <small>üìû ${b.phone}</small>
            </div>
        </div>
    `).join('');
}

// ================= –ú–ê–°–¢–ï–†-–ü–ê–ù–ï–õ–¨ =================
function loginMaster() {
    const password = document.getElementById('masterPassword').value;
    
    if (password === MASTER_PASSWORD) {
        isMasterMode = true;
        document.getElementById('masterPassword').value = '';
        updateDebug("üîì –í—Ö–æ–¥ –º–∞—Å—Ç–µ—Ä–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω");
        showScreen('masterPanel');
    } else {
        alert('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å!');
    }
}

function logoutMaster() {
    isMasterMode = false;
    updateDebug("üîí –í—ã—Ö–æ–¥ –º–∞—Å—Ç–µ—Ä–∞");
    showScreen('main');
}

async function refreshMasterPanel() {
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ Google Sheets
    await loadFromGoogleSheets();
    
    // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    const today = new Date().toISOString().split('T')[0];
    const todayBookings = allBookings.filter(b => b.date === today);
    const revenue = allBookings.reduce((sum, b) => sum + (b.price || 0), 0);
    
    document.getElementById('totalBookings').textContent = allBookings.length;
    document.getElementById('todayBookings').textContent = todayBookings.length;
    document.getElementById('totalRevenue').textContent = revenue;
    
    // –í—Å–µ –∑–∞–ø–∏—Å–∏
    const container = document.getElementById('allBookingsList');
    if (allBookings.length === 0) {
        container.innerHTML = '<p style="text-align:center;padding:20px;">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</p>';
        return;
    }
    
    // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –¥–∞—Ç–µ (–Ω–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É)
    const sorted = [...allBookings].sort((a, b) => new Date(b.date) - new Date(a.date));
    
    container.innerHTML = sorted.map(b => `
        <div class="booking-card" style="margin:8px 0;">
            <div style="display:flex;justify-content:space-between;">
                <div>
                    <strong>${b.service}</strong><br>
                    <small>üë§ ${b.userName}</small>
                </div>
                <div>
                    <span class="status-badge status-${b.status === 'confirmed' ? 'confirmed' : 'pending'}" 
                          onclick="changeStatus(${b.id}, '${b.status === 'confirmed' ? 'pending' : 'confirmed'}')"
                          style="cursor:pointer;">
                        ${b.status === 'confirmed' ? '‚úÖ' : '‚è≥'}
                    </span>
                </div>
            </div>
            <div style="margin-top:8px;font-size:14px;">
                <div>üìÖ ${b.date} üïê ${b.time}</div>
                <div>üìû ${b.phone}</div>
                <div>üíµ ${b.price}‚ÇΩ ‚Ä¢ ID: ${b.userId}</div>
            </div>
        </div>
    `).join('');
}

function changeStatus(bookingId, newStatus) {
    const booking = allBookings.find(b => b.id === bookingId);
    if (booking) {
        booking.status = newStatus;
        saveLocalData();
        refreshMasterPanel();
    }
}

async function exportToGoogleSheets() {
    updateDebug("üì§ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö —Å Google Sheets...");
    
    let successCount = 0;
    let errorCount = 0;
    
    for (const booking of allBookings) {
        const success = await saveToGoogleSheets(booking);
        if (success) successCount++;
        else errorCount++;
        
        // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞—Ç—å
        await new Promise(resolve => setTimeout(resolve, 100));
    }
    
    alert(`–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!\n–£—Å–ø–µ—à–Ω–æ: ${successCount}\n–û—à–∏–±–æ–∫: ${errorCount}`);
}

function exportToJSON() {
    const data = JSON.stringify(allBookings, null, 2);
    const blob = new Blob([data], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `nail_sakura_bookings_${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    updateDebug("üì• –î–∞–Ω–Ω—ã–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –≤ JSON");
}

// ================= –£–¢–ò–õ–ò–¢–´ =================
function updateDebug(message) {
    console.log(message);
    document.getElementById('debug').textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
}

// ================= –ó–ê–ü–£–°–ö =================
document.addEventListener('DOMContentLoaded', initApp);
</script>
</body>
</html>
