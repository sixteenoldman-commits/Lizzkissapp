<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üå∏ Nail Sakura</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial; background: #FFE4E9; padding: 20px; padding-bottom: 80px; }
        .screen { display: none; }
        .screen.active { display: block; animation: fadeIn 0.3s; }
        .btn { display: block; width: 100%; padding: 16px; margin: 10px 0; background: #FFB6C1; color: white; border: none; border-radius: 12px; font-size: 16px; cursor: pointer; }
        .btn:active { transform: scale(0.98); }
        .btn-master { background: #8B475D; }
        input, select { width: 100%; padding: 14px; margin: 8px 0; border: 2px solid #FFB6C1; border-radius: 10px; }
        .booking-card { background: white; padding: 15px; margin: 10px 0; border-radius: 10px; border-left: 5px solid #FFB6C1; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: white; display: flex; padding: 10px; border-top: 2px solid #FFB6C1; }
        .nav-btn { flex: 1; padding: 10px; border: none; background: none; font-size: 20px; color: #888; }
        .nav-btn.active { color: #FFB6C1; }
        .status { padding: 3px 8px; border-radius: 5px; font-size: 12px; margin-left: 10px; }
        .status-pending { background: #FFF3CD; color: #856404; }
        .status-confirmed { background: #D4EDDA; color: #155724; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .debug { font-size: 12px; color: #666; padding: 5px; background: #f0f0f0; border-radius: 3px; margin: 5px 0; }
    </style>
</head>
<body>
    <div class="debug" id="debug">–ó–∞–≥—Ä—É–∑–∫–∞...</div>

    <!-- –≠–ö–†–ê–ù 1: –ì–õ–ê–í–ù–ê–Ø -->
    <div id="mainScreen" class="screen active">
        <div style="text-align:center; margin:20px 0;">
            <div id="userAvatar" style="width:80px;height:80px;background:#FFB6C1;border-radius:50%;margin:0 auto;font-size:36px;line-height:80px;">üë§</div>
            <h2 id="userName">–ó–∞–≥—Ä—É–∑–∫–∞...</h2>
            <p id="userInfo" style="color:#8B475D;">Nail Sakura Studio</p>
        </div>
        <button class="btn" onclick="showScreen('booking')">üíÖ –ó–∞–ø–∏—Å–∞—Ç—å—Å—è</button>
        <button class="btn" onclick="showScreen('services')">‚ú® –£—Å–ª—É–≥–∏</button>
        <button class="btn" onclick="showScreen('myBookings')">üìÖ –ú–æ–∏ –∑–∞–ø–∏—Å–∏</button>
        <button class="btn btn-master" onclick="showScreen('masterLogin')">‚öôÔ∏è –í—Ö–æ–¥ –¥–ª—è –º–∞—Å—Ç–µ—Ä–∞</button>
    </div>

    <!-- –≠–ö–†–ê–ù 2: –ó–ê–ü–ò–°–¨ -->
    <div id="bookingScreen" class="screen">
        <button onclick="showScreen('main')" style="background:none;border:none;font-size:24px;cursor:pointer;">‚Üê</button>
        <h2>üìù –ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å</h2>
        <div id="servicesList">
            <!-- –£—Å–ª—É–≥–∏ –∑–∞–≥—Ä—É–∑—è—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ -->
        </div>
        <input type="date" id="bookingDate">
        <select id="bookingTime">
            <option>10:00</option><option>11:00</option><option>12:00</option><option>13:00</option>
            <option>14:00</option><option>15:00</option><option>16:00</option><option>17:00</option><option>18:00</option>
        </select>
        <input type="tel" id="clientPhone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
        <button class="btn" onclick="submitBooking()">‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–ø–∏—Å—å</button>
    </div>

    <!-- –≠–ö–†–ê–ù 3: –£–°–õ–£–ì–ò -->
    <div id="servicesScreen" class="screen">
        <button onclick="showScreen('main')" style="background:none;border:none;font-size:24px;cursor:pointer;">‚Üê</button>
        <h2>üíÖ –£—Å–ª—É–≥–∏</h2>
        <div id="servicesContainer"></div>
    </div>

    <!-- –≠–ö–†–ê–ù 4: –ú–û–ò –ó–ê–ü–ò–°–ò -->
    <div id="myBookingsScreen" class="screen">
        <button onclick="showScreen('main')" style="background:none;border:none;font-size:24px;cursor:pointer;">‚Üê</button>
        <h2>üìÖ –ú–æ–∏ –∑–∞–ø–∏—Å–∏</h2>
        <div id="bookingsList">
            <p style="text-align:center;padding:40px;">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
        </div>
    </div>

    <!-- –≠–ö–†–ê–ù 5: –í–•–û–î –ú–ê–°–¢–ï–†–ê -->
    <div id="masterLoginScreen" class="screen">
        <button onclick="showScreen('main')" style="background:none;border:none;font-size:24px;cursor:pointer;">‚Üê</button>
        <div style="text-align:center; margin:40px 0;">
            <div style="font-size:50px;">üîê</div>
            <h2>–í—Ö–æ–¥ –¥–ª—è –º–∞—Å—Ç–µ—Ä–∞</h2>
            <p>–ü–∞—Ä–æ–ª—å: sakura2024</p>
        </div>
        <input type="password" id="masterPassword" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
        <button class="btn" onclick="loginMaster()">–í–æ–π—Ç–∏</button>
    </div>

    <!-- –≠–ö–†–ê–ù 6: –ü–ê–ù–ï–õ–¨ –ú–ê–°–¢–ï–†–ê -->
    <div id="masterPanelScreen" class="screen">
        <button onclick="logoutMaster()" style="background:none;border:none;font-size:24px;cursor:pointer;">‚Üê –í—ã–π—Ç–∏</button>
        <h2>‚öôÔ∏è –ü–∞–Ω–µ–ª—å –º–∞—Å—Ç–µ—Ä–∞</h2>
        <div style="background:#FFE4E9;padding:15px;border-radius:10px;margin:10px 0;">
            <h3>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
            <p>–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π: <span id="totalBookings">0</span></p>
            <p>–ù–∞ —Å–µ–≥–æ–¥–Ω—è: <span id="todayBookings">0</span></p>
            <p>–í—ã—Ä—É—á–∫–∞: <span id="totalRevenue">0</span>‚ÇΩ</p>
        </div>
        <div id="allBookingsList" style="max-height:400px;overflow-y:auto;">
            <!-- –í—Å–µ –∑–∞–ø–∏—Å–∏ –±—É–¥—É—Ç –∑–¥–µ—Å—å -->
        </div>
        <button class="btn" onclick="refreshMasterPanel()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
        <button class="btn" onclick="exportData()">üì• –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</button>
    </div>

    <!-- –ù–ò–ñ–ù–Ø–Ø –ù–ê–í–ò–ì–ê–¶–ò–Ø -->
    <nav class="bottom-nav">
        <button class="nav-btn active" onclick="showScreen('main')">üè†</button>
        <button class="nav-btn" onclick="showScreen('booking')">üíÖ</button>
        <button class="nav-btn" onclick="showScreen('services')">‚ú®</button>
        <button class="nav-btn" onclick="showScreen('myBookings')">üìÖ</button>
    </nav>

<script>
// ================= –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø =================
const API_URL = "http://localhost:3000/api";
const MASTER_PASSWORD = "sakura2024";

// ================= –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï =================
let currentUser = null;
let currentScreen = 'main';
let isMasterMode = false;
let allServices = [];

// ================= TELEGRAM + –ë–ê–ó–ê =================
async function initApp() {
    debug("–ó–∞–≥—Ä—É–∑–∫–∞...");
    
    // –ü–æ–ª—É—á–∞–µ–º —É—Å–ª—É–≥–∏ –∏–∑ –±–∞–∑—ã
    try {
        const response = await fetch(`${API_URL}/services`);
        const data = await response.json();
        allServices = data.services;
        loadServices();
    } catch (error) {
        debug("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É—Å–ª—É–≥");
        allServices = [
            {id: 1, name: "–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –º–∞–Ω–∏–∫—é—Ä", price: 1500},
            {id: 2, name: "–ü–æ–∫—Ä—ã—Ç–∏–µ –≥–µ–ª—å-–ª–∞–∫–æ–º", price: 2000}
        ];
    }
    
    // Telegram –¥–∞–Ω–Ω—ã–µ
    if (window.Telegram?.WebApp) {
        const tg = Telegram.WebApp;
        tg.expand();
        const user = tg.initDataUnsafe?.user;
        
        if (user) {
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º/–ø–æ–ª—É—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            await saveUserToDB({
                telegramId: user.id,
                firstName: user.first_name,
                lastName: user.last_name || '',
                username: user.username
            });
            
            currentUser = {
                id: user.id,
                name: user.first_name + (user.last_name ? ' ' + user.last_name : ''),
                photo: user.photo_url
            };
        } else {
            currentUser = {id: 'guest', name: '–ì–æ—Å—Ç—å'};
        }
    } else {
        currentUser = {id: 'guest', name: '–ì–æ—Å—Ç—å'};
    }
    
    updateUI();
    debug("–ì–æ—Ç–æ–≤–æ!");
}

// ================= –†–ê–ë–û–¢–ê –° –ë–ê–ó–û–ô =================
async function saveUserToDB(userData) {
    try {
        await fetch(`${API_URL}/user`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(userData)
        });
    } catch (error) {
        console.log("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:", error);
    }
}

async function submitBooking() {
    const serviceId = document.querySelector('input[name="service"]:checked')?.value;
    const date = document.getElementById('bookingDate').value;
    const time = document.getElementById('bookingTime').value;
    const phone = document.getElementById('clientPhone').value;
    
    if (!serviceId || !date) {
        alert("–í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É –∏ –¥–∞—Ç—É!");
        return;
    }
    
    const service = allServices.find(s => s.id == serviceId);
    
    const bookingData = {
        userId: currentUser.id,
        userName: currentUser.name,
        serviceId: serviceId,
        serviceName: service.name,
        price: service.price,
        date: date,
        time: time,
        phone: phone || '–Ω–µ —É–∫–∞–∑–∞–Ω'
    };
    
    try {
        const response = await fetch(`${API_URL}/booking`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(bookingData)
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert(`üéâ –ó–∞–ø–∏—Å—å —Å–æ–∑–¥–∞–Ω–∞!\n${service.name}\n${date} –≤ ${time}`);
            showScreen('main');
        } else {
            alert("–û—à–∏–±–∫–∞: " + result.error);
        }
    } catch (error) {
        alert("–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º");
        console.error(error);
    }
}

async function loadUserBookings() {
    try {
        const response = await fetch(`${API_URL}/bookings`);
        const data = await response.json();
        
        if (data.success) {
            const userBookings = data.bookings.filter(b => b.userId == currentUser.id);
            displayBookings(userBookings, 'bookingsList');
        }
    } catch (error) {
        document.getElementById('bookingsList').innerHTML = '<p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p>';
    }
}

async function loadAllBookings() {
    try {
        const response = await fetch(`${API_URL}/bookings`);
        const data = await response.json();
        
        if (data.success) {
            displayAllBookings(data.bookings);
            
            // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
            const today = new Date().toISOString().split('T')[0];
            const todayBookings = data.bookings.filter(b => b.date === today);
            const revenue = data.bookings.reduce((sum, b) => sum + (b.price || 0), 0);
            
            document.getElementById('totalBookings').textContent = data.bookings.length;
            document.getElementById('todayBookings').textContent = todayBookings.length;
            document.getElementById('totalRevenue').textContent = revenue;
        }
    } catch (error) {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–ø–∏—Å–µ–π:", error);
    }
}

// ================= –ú–ê–°–¢–ï–†-–ü–ê–ù–ï–õ–¨ =================
async function loginMaster() {
    const password = document.getElementById('masterPassword').value;
    
    if (password === MASTER_PASSWORD) {
        isMasterMode = true;
        document.getElementById('masterPassword').value = '';
        showScreen('masterPanel');
        loadAllBookings();
    } else {
        alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å!");
    }
}

function logoutMaster() {
    isMasterMode = false;
    showScreen('main');
}

async function updateBookingStatus(bookingId, status) {
    try {
        await fetch(`${API_URL}/booking/${bookingId}`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({status})
        });
        loadAllBookings();
    } catch (error) {
        console.error("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:", error);
    }
}

// ================= –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –î–ê–ù–ù–´–• =================
function loadServices() {
    // –î–ª—è —ç–∫—Ä–∞–Ω–∞ –∑–∞–ø–∏—Å–∏
    const servicesList = document.getElementById('servicesList');
    if (servicesList) {
        servicesList.innerHTML = allServices.map(service => `
            <div style="margin:10px 0;padding:10px;background:white;border-radius:10px;">
                <label style="display:flex;align-items:center;cursor:pointer;">
                    <input type="radio" name="service" value="${service.id}" style="margin-right:10px;">
                    <div>
                        <strong>${service.name}</strong><br>
                        <small>${service.price}‚ÇΩ ‚Ä¢ ${service.duration || 60} –º–∏–Ω</small>
                    </div>
                </label>
            </div>
        `).join('');
    }
    
    // –î–ª—è —ç–∫—Ä–∞–Ω–∞ —É—Å–ª—É–≥
    const servicesContainer = document.getElementById('servicesContainer');
    if (servicesContainer) {
        servicesContainer.innerHTML = allServices.map(service => `
            <div class="booking-card">
                <h3>${service.name}</h3>
                <p>${service.description || ''}</p>
                <strong>${service.price}‚ÇΩ</strong>
                <small style="color:#666;"> ‚Ä¢ ${service.duration || 60} –º–∏–Ω</small>
            </div>
        `).join('');
    }
}

function displayBookings(bookings, containerId) {
    const container = document.getElementById(containerId);
    if (!container) return;
    
    if (bookings.length === 0) {
        container.innerHTML = '<p style="text-align:center;padding:40px;">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π</p>';
        return;
    }
    
    container.innerHTML = bookings.map(booking => `
        <div class="booking-card">
            <strong>${booking.serviceName || booking.service}</strong><br>
            <small>üìÖ ${booking.date} üïê ${booking.time}</small><br>
            <span class="status status-${booking.status || 'pending'}">
                ${booking.status === 'confirmed' ? '‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ' : '‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ'}
            </span>
            ${booking.price ? `<br><small>${booking.price}‚ÇΩ</small>` : ''}
        </div>
    `).join('');
}

function displayAllBookings(bookings) {
    const container = document.getElementById('allBookingsList');
    if (!container) return;
    
    if (bookings.length === 0) {
        container.innerHTML = '<p>–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</p>';
        return;
    }
    
    container.innerHTML = bookings.reverse().map(booking => `
        <div class="booking-card" style="margin:8px 0;font-size:14px;">
            <div style="display:flex;justify-content:space-between;">
                <strong>${booking.serviceName || booking.service}</strong>
                <span class="status status-${booking.status || 'pending'}">
                    ${booking.status || 'pending'}
                </span>
            </div>
            <small>üìÖ ${booking.date} üïê ${booking.time}</small><br>
            <small>üë§ ${booking.userName || '–ö–ª–∏–µ–Ω—Ç'} (${booking.phone || '–±–µ–∑ —Ç–µ–ª–µ—Ñ–æ–Ω–∞'})</small><br>
            <small>üíµ ${booking.price || 0}‚ÇΩ</small>
            <div style="margin-top:8px;">
                <button onclick="updateBookingStatus(${booking.id}, 'pending')" style="padding:3px 8px;margin-right:5px;">‚è≥</button>
                <button onclick="updateBookingStatus(${booking.id}, 'confirmed')" style="padding:3px 8px;margin-right:5px;">‚úÖ</button>
                <button onclick="updateBookingStatus(${booking.id}, 'completed')" style="padding:3px 8px;">üèÅ</button>
            </div>
        </div>
    `).join('');
}

// ================= –£–¢–ò–õ–ò–¢–´ =================
function showScreen(screenName) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById(screenName + 'Screen').classList.add('active');
    currentScreen = screenName;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∏–∂–Ω–µ–µ –º–µ–Ω—é
    document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
    if (screenName === 'main') document.querySelector('.nav-btn:nth-child(1)').classList.add('active');
    if (screenName === 'booking') document.querySelector('.nav-btn:nth-child(2)').classList.add('active');
    if (screenName === 'services') document.querySelector('.nav-btn:nth-child(3)').classList.add('active');
    if (screenName === 'myBookings') document.querySelector('.nav-btn:nth-child(4)').classList.add('active');
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
    if (screenName === 'myBookings') setTimeout(() => loadUserBookings(), 100);
    if (screenName === 'masterPanel') setTimeout(() => loadAllBookings(), 100);
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ–≥–æ–¥–Ω—è—à–Ω—é—é –¥–∞—Ç—É
    if (screenName === 'booking') {
        const today = new Date().toISOString().split('T')[0];
        const dateInput = document.getElementById('bookingDate');
        if (dateInput) {
            dateInput.value = today;
            dateInput.min = today;
        }
    }
}

function updateUI() {
    if (!currentUser) return;
    
    document.getElementById('userName').textContent = `–ü—Ä–∏–≤–µ—Ç, ${currentUser.name}!`;
    
    const avatar = document.getElementById('userAvatar');
    if (currentUser.photo) {
        avatar.innerHTML = `<img src="${currentUser.photo}" style="width:100%;height:100%;border-radius:50%;">`;
    } else if (currentUser.name) {
        avatar.textContent = currentUser.name[0].toUpperCase();
    }
}

function debug(message) {
    console.log(message);
    document.getElementById('debug').textContent = message;
}

function refreshMasterPanel() {
    loadAllBookings();
}

function exportData() {
    fetch(`${API_URL}/bookings`)
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                const json = JSON.stringify(data.bookings, null, 2);
                const blob = new Blob([json], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `bookings_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                alert("–î–∞–Ω–Ω—ã–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –≤ JSON!");
            }
        });
}

// ================= –ó–ê–ü–£–°–ö =================
document.addEventListener('DOMContentLoaded', initApp);
</script>
</body>
</html>
